#!/usr/bin/env bash
# Pre-commit: run clang-format on staged C++ files and fail if formatting changes.

set -euo pipefail

CLANG_FORMAT_BIN="${CLANG_FORMAT_BIN:-}"
if [[ -z "$CLANG_FORMAT_BIN" ]]; then
    for candidate in clang-format-20 clang-format-19 clang-format-18 clang-format; do
        if command -v "$candidate" >/dev/null 2>&1; then
            CLANG_FORMAT_BIN="$candidate"
            break
        fi
    done
fi

if [[ -z "$CLANG_FORMAT_BIN" ]]; then
    echo "warning: clang-format not found; skipping format check" >&2
    exit 0
fi

FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.cpp' '*.hpp' || true)
if [[ -z "${FILES}" ]]; then
    exit 0
fi

FAILED=0
while IFS= read -r file; do
    [[ -z "$file" ]] && continue
    "$CLANG_FORMAT_BIN" -i "$file"
    git add "$file"
    if ! "$CLANG_FORMAT_BIN" --dry-run --Werror "$file"; then
        FAILED=1
    fi
done <<< "$FILES"

if [[ "$FAILED" -ne 0 ]]; then
    echo "error: clang-format check failed. Run clang-format on the files above." >&2
    exit 1
fi
